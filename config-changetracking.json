{
  "es": {
    "dev": {
      "host": "clclcdcdvm001",
      "port": "9200",
      "index": "cdc"
    },
    "staging": {
      "host": "clclcdcdvm001",
      "port": "9200",
      "index": "cdc"
    },
    "prod": {
      "host": "clclcdcpvm001",
      "port": "9200",
      "index": "cdc"
    }
  },
  "sleep_ms": 5000,
  "sqlproxy": {
    "rnumber": {
      "dev": {
        "host": "clcwcdcdvm001",
        "port": "5550"
      },
      "staging": {
        "host": "clcwcdcdvm001",
        "port": "5550"
      },
      "prod": {
        "host": "clcwcdcpvm005",
        "port": "5550"
      }
    },
    "crms": {
      "dev": {
        "host": "clcwcdcdvm001",
        "port": "5551"
      },
      "staging": {
        "host": "clcwcdcdvm001",
        "port": "5551"
      },
      "prod": {
        "host": "clcwcdcpvm005",
        "port": "5551"
      }
    },
    "irb": {
      "dev": {
        "host": "clcwcdcdvm001",
        "port": "5552"
      },
      "staging": {
        "host": "clcwcdcdvm001",
        "port": "5552"
      },
      "prod": {
        "host": "clcwcdcpvm005",
        "port": "5552"
      }
    },
    "iacuc": {
      "dev": {
        "host": "clcwcdcdvm001",
        "port": "5553"
      },
      "staging": {
        "host": "clcwcdcdvm001",
        "port": "5553"
      },
      "prod": {
        "host": "clcwcdcpvm005",
        "port": "5553"
      }
    },
    "dlar": {
      "dev": {
        "host": "clcwcdcdvm001",
        "port": "5554"
      },
      "staging": {
        "host": "clcwcdcdvm001",
        "port": "5554"
      },
      "prod": {
        "host": "clcwcdcpvm005",
        "port": "5554"
      }
    },
    "animalcensus": {
      "dev": {
        "host": "clcwcdcdvm001",
        "port": "5555"
      },
      "staging": {
        "host": "clcwcdcdvm001",
        "port": "5555"
      },
      "prod": {
        "host": "clcwcdcpvm005",
        "port": "5555"
      }
    }
  },
  "connection": {
    "rnumber": {
      "dev": {
        "host": "clcwcdcdap001",
        "database": "ResearchNavigator",
        "user": "hackclick",
        "pass": "12345678",
        "meta": { "foo": 123 }
      },
      "staging": {
        "host": "clcwcdcpap008",
        "database": "ResearchNavigator",
        "user": "hackclick",
        "pass": "12345678"
      },
      "prod": {
        "host": "SQLP91003\\DB03",
        "database": "ResearchNavigator",
        "user": "hackclick",
        "pass": "12345678"
      }
    },
    "crms": {
      "dev": {
        "host": "SQLP91002\\DB02",
        "database": "CRMS",
        "user": "hackclick",
        "pass": "12345678"
      },
      "staging": {
        "host": "clcwcdcpap008",
        "database": "CRMS",
        "user": "hackclick",
        "pass": "12345678"
      },
      "prod": {
        "host": "SQLP91002\\DB02",
        "database": "CRMS",
        "user": "hackclick",
        "pass": "12345678"
      }
    },
    "iacuc": {
      "dev": {
        "host": "clcwcdcdap001",
        "database": "IACUC",
        "user": "hackclick",
        "pass": "12345678"
      },
      "staging": {
        "host": "clcwcdcdap001",
        "database": "[IACUC.QA]",
        "user": "hackclick",
        "pass": "12345678"
      },
      "prod": {
        "host": "SQLP91003\\DB03",
        "database": "IACUC",
        "user": "hackclick",
        "pass": "12345678"
      }
    },
    "dlar": {
      "dev": {
        "host": "clcwcdcdap001",
        "database": "DLAR",
        "user": "hackclick",
        "pass": "12345678"
      },
      "staging": {
        "host": "clcwcdcdap001",
        "database": "[DLAR.QA]",
        "user": "hackclick",
        "pass": "12345678"
      },
      "prod": {
        "host": "SQLP91003\\DB03",
        "database": "DCM",
        "user": "hackclick",
        "pass": "12345678"
      }
    },
    "animalcensus": {
      "dev": {
        "host": "clcwcdcpap008",
        "database": "AnimalCensus",
        "user": "hackclick",
        "pass": "12345678"
      },
      "staging": {
        "host": "clcwcdcpap008",
        "database": "AnimalCensus",
        "user": "hackclick",
        "pass": "12345678"
      },
      "prod": {
        "host": "SQLP91003\\DB03",
        "database": "AnimalCensus",
        "user": "hackclick",
        "pass": "12345678"
      }
    }
  },
  "channels": {
    "dlar": [
      {
        "name": "dcm:activity:changetracking",
        "modelName": "Activity",
        "script": [
          "set nocount on;\n",
          "declare @begin_time datetime, @end_time datetime, @from_lsn binary(10), @to_lsn binary(10);\n",
          "-- Obtain the beginning of the time interval.\n",
          "-- set @begin_time = GETDATE() -1;\n",
          "SET @begin_time = dateadd(ss, 1, $(LAST_EXEC_TIME) );\n",
          "-- Get create date of cdc table\n",
          "declare @cdc_create_date datetime;\n",
          "select @cdc_create_date = create_date from cdc.change_tables where capture_instance = 'dbo__Activity';\n",
          "if (@begin_time < @cdc_create_date) begin set @begin_time = @cdc_create_date; end;\n",          
          "-- Obtain the end of the time interval.\n",
          "SET @end_time = GETDATE();\n",
          "-- Map the time interval to a change data capture query range.\n",
          "SET @from_lsn = sys.fn_cdc_map_time_to_lsn('smallest greater than or equal', @begin_time);\n",
          "SET @to_lsn = sys.fn_cdc_map_time_to_lsn('largest less than or equal', @end_time);\n",
          "-- Find local/utc time offset.\n",
          "declare @local_time_offset bigint;\n",
          "set @local_time_offset = datediff(second,getdate(),getutcdate());\n",
          "\n",
          "select convert(varchar(max), z.oid, 2) activityId, y.activityName, y.forType, y.submittedFormSnapshot formHtml, y.[xml] changeXml, left(convert(varchar(24), dateadd(second, (y.activityDate * 0.001) - @local_time_offset, cast('1970-01-01 00:00:00' as datetime)), 126), 19) activityDate, left(convert(varchar(24), y.start_time, 126), 19) start_time\n", 
          "from (\n", 
          "  select a.oid, a.activitytype, a.activitydate, a.changetrackinginfo, a.__$operation, max(sys.fn_cdc_map_lsn_to_time ( __$start_lsn )) max_start_time\n",
          "  from cdc.fn_cdc_get_all_changes_dbo__Activity(@from_lsn, @to_lsn, 'all') a where a.__$operation = 2 group by a.oid, a.activitytype, a.activitydate, a.changetrackinginfo, a.__$operation\n",
          ") z\n",
          "inner join (\n", 
          "  select sys.fn_cdc_map_lsn_to_time ( __$start_lsn ) start_time, a.__$start_lsn, a.__$seqval, a.__$operation, a.__$update_mask, a.oid, a.activitytype, a.activitydate, a.changetrackinginfo, ac.forType, ac._webrunique_id activityName, coalesce(a1.submittedFormSnapshot,'') submittedFormSnapshot, cd.[xml] FROM cdc.fn_cdc_get_all_changes_dbo__Activity(@from_lsn, @to_lsn, 'all') a inner join _activity a1 on a1.oid = a.oid inner join _activitytype ac on a.activitytype = ac.oid inner join _changetrackingdetails cd on cd.oid = a.changetrackinginfo\n",
          "  where ac.forType is not null\n", 
          ") y\n",
          "on z.oid = y.oid and z.activitytype = y.activitytype and z.activitydate = y.activitydate and z.changetrackinginfo = y.changetrackinginfo and z.__$operation = y.__$operation and z.max_start_time = y.start_time\n"
        ]
      }

    ]
  } 
}